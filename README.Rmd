---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
    message = F,
    warning = F,
    collapse = TRUE,
    comment = "#>",
    fig.path = "README-"
)
```


# alphavantagepf 

> A data.table centric R interface to the Alpha Vantage API, geared towards personal finance applications.

## Alpha Vantage

Alpha Vantage is a financial markets data provider which provides limited __free data__ and higher bandwidth and real-time quotes for reasonable costs.  For further details, see 
[Alpha Vantage](https://www.alphavantage.co/) where API keys can be obtained.

Data is obtained from the API by using key functions, descriptions of which can be obtained using [Alphavantage documentation](https://www.alphavantage.co/documentation/)


## R Interface: Getting Started

The `alphavantagepf` package leverages the R `data.table` package to provide fast and organized data retrieval.  Data is typically returned in "melted" or normalized forms

To get started, install the package from from GitHub:

```{r, eval = F}
devtools::install_github("derekholmes0/alphavantagepf")
```

Load the package.

```{r}
library(alphavantagepf)
```

Set your API key obtained from [Alpha Vantage](https://www.alphavantage.co/).

```{r}
av_api_key("YOUR_API_KEY")
print(av_api_key())
```

## Finding Functions and their defaults""

To find parameters and defaults provided by the `alphavantagepf` package, use `av_funhelp()`

```{r}
av_funhelp("SERIES_INTRADAY")
```

Required parameters are listed with "R" and optional parameters (and any default provided by this package) are listed with "O"


## Getting Data from Alpha Vantage

Once the API key has been set, use the function `av_get_pf()` which requires at minimum two arguments, a `symbol` (put first to facilitate usage in pipes) and an Alphavantage "function" `av_fun`. 


```{r}
av_get_pf("IBM","TIME_SERIES_INTRADAY") |> head()
```

Note that data is returned in a `data.table`, which can be cast as tibbles as necessary.  


## More complex data and hepful data extractors.

Some API calls return more complex data, i.e. data with strings, numbers, and nested data.frames collected together.  By defauly, `av_get_pf()` returns everything the API returns, but in 
a long form with columns for returned variables and each data type.  For example, the `TOP_GAINERS_LOSERS` function returns separate data.frames for each category.

```{r}
av_get_pf("","TOP_GAINERS_LOSERS")
```

* Note that symbol for `TOP_GAINERS_LOSERS` isn't used, but still needs to be specified.
* Note that the data returned is in long form, and always has at least three columns, `symbol` (which cna be changed in `av_get_pf()` optional parameters). `variable` which is the name of the data item returned, and (e.g.) `value_str` or `value_df` with appropriate data components.
The data is separated out by type so further delisting doesn't have to be done after the call.

If you want to just get, e.g. the top losers, the returned data can be piped into the `av_extract_df()` function:

```{r}
av_get_pf("","TOP_GAINERS_LOSERS") |> av_extract_df("top_losers")
```

## Other extracting helper examples

### Foreign exchange

The returned data from the `CURRENCY_EXCHANGE_RATE` is a bit complex, and can be simplified with 

```{r, eval=F}
# REAL-TIME QUOTE
av_get_pf("USD/BRL","CURRENCY_EXCHANGE_RATE") |> av_extract_fx()
```

```
Key: <symbol>
    symbol   Ask   Bid      QuoteTimestamp   Mid
    <char> <num> <num>              <POSc> <num>
1: USD/BRL  5.37  5.37 2026-01-06 15:47:46  5.37
```

## Options

The `HISTORICAL_OPTIONS` function returns a large set of options for any given ticker, many of which are long dated or have no opent interest.
The `av_grep_opts()` helper can be used to narrow those down using a comma-separated string specifying 
  1. How far out maturities should be returned, e.g. Front Month or Back month
  2. What expiration schedules should be used, e.g. "Q" for Quarterly or "M" for monthlies.
  3. Calls or Puts.

So, for example, to get the closest monthly puts with at least 2 days to maturity, use 


```{r, eval=F}
av_get_pf("IBM","HISTORICAL_OPTIONS") |> av_grep_opts("F,M,put",mindays=2)
```

```
   symbol         contractID expiration strike   type  last  mark   bid bid_size   ask ask_size volume open_interest       date implied_volatility  delta  gamma  theta   vega     rho
   <char>             <char>     <IDat>  <num> <char> <num> <num> <num>    <int> <num>    <int>  <int>         <int>     <IDat>              <num>  <num>  <num>  <num>  <num>   <num>
1:    IBM IBM260116P00277500 2026-01-16    278    put  0.00  0.80  0.67      158  0.94      254      0            33 2026-01-05              0.298 -0.110 0.0123 -0.127 0.0961 -0.0100
2:    IBM IBM260116P00280000 2026-01-16    280    put  0.98  0.96  0.90      180  1.02       10    111          1443 2026-01-05              0.278 -0.130 0.0149 -0.133 0.1085 -0.0119
3:    IBM IBM260116P00282500 2026-01-16    282    put  1.32  1.29  1.17      213  1.41      158     14           272 2026-01-05              0.269 -0.165 0.0181 -0.150 0.1272 -0.0150
```

## Important Notes: av_get_pf()

1. Three parameters `apikey`, `datatype` and `outputsize` are filled into the API call from the package.  `outputsize` defaults to the full dataset, and can be overridden as a named parameter to the `av_get_pf()` call.

2. `symbol` is always returned in the output dataset, and defaults to the name of the `av_fun` call if no symbol is relevant.

3. There is no need to specify the `datatype` parameter as an argument to `av_get()`. The function will return a tibble data frame. 

4. Multiple symbols in one API call are currently unsupported.
